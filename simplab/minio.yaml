---

- name: Configure MinIO
  hosts: simplabcp,simplabwk
  gather_facts: false
  tasks:

    - name: Install MinIO kubectl plugin
      ansible.builtin.get_url:
        url: https://github.com/minio/operator/releases/download/v4.5.6/kubectl-minio_4.5.6_linux_amd64
        dest: /usr/local/bin/kubectl-minio
        owner: root
        group: root
        mode: 0755

    - name: Install MinIO operator
      ansible.builtin.command:
        cmd: kubectl minio init --kubeconfig /etc/kubernetes/admin.conf
      when: initial_control_plane == inventory_hostname

    - name: Create namespace for MinIO tenant
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: minio
        kubeconfig: /etc/kubernetes/admin.conf
      when: initial_control_plane == inventory_hostname

    - name: Create MinIO tenant for Mimir
      ansible.builtin.command:
        cmd: kubectl minio tenant create mimir --capacity 16Gi --servers 2 --volumes 4 --namespace minio --kubeconfig /etc/kubernetes/admin.conf
      when: initial_control_plane == inventory_hostname
